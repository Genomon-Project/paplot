(function() {
mut_data = {};
mut_data.mutations = [[0,0,3,1,[['T','chr16','68795530','-','68795521',],]],[0,0,12,1,[['-','chr12','25399430','T','25399424',],]],[0,2,7,1,[['-','chr13','28644901','G','28644892',],]],[0,3,21,1,[['T','chr14','103320225','-','103320225',],]],[0,4,3,2,[['-','chr16','68855434','T','68855428',],['T','chr16','68837004','C','68836998',],]],[0,4,4,1,[['C','chr1','26505557','T','26505548',],]],[0,4,7,1,[['T','chr13','28586661','G','28586656',],]],[0,4,8,2,[['T','chr10','8117069','G','8117068',],['A','chr10','8116979','-','8116977',],]],[0,4,12,1,[['T','chr12','25401277','C','25401272',],]],[0,4,19,2,[['A','chr10','89687911','C','89687907',],['T','chr10','89691359','C','89691359',],]],[0,5,7,1,[['-','chr13','28603715','G','28603715',],]],[0,6,2,1,[['G','chr7','140619979','-','140619975',],]],[0,6,4,1,[['T','chr1','26513115','-','26513111',],]],[0,6,7,1,[['G','chr13','28664638','-','28664636',],]],[0,6,8,1,[['C','chr10','8114474','A','8114472',],]],[0,6,18,1,[['A','chr3','178906688','G','178906688',],]],[0,6,19,1,[['C','chr10','89653888','A','89653886',],]],[0,6,21,1,[['C','chr14','103368270','G','103368263',],]],[1,0,15,1,[['T','chr2','178109274','C','178109271',],]],[1,3,22,1,[['C','chr13','27152646','T','27152639',],]],[1,4,16,2,[['T','chr1','115259258','G','115259257',],['G','chr1','115247291','-','115247289',],]],[1,4,17,2,[['A','chr15','31799857','G','31799857',],['A','chr15','31820610','T','31820606',],]],[1,6,9,4,[['A','chr6','44215273','-','44215264',],['C','chr6','44215800','T','44215791',],['A','chr6','44219301','-','44219299',],['-','chr6','44218899','T','44218898',],]],[1,6,15,2,[['-','chr2','178099212','T','178099203',],['G','chr2','178101343','C','178101335',],]],[1,6,16,4,[['T','chr1','115253017','-','115253017',],['-','chr1','115257611','A','115257608',],['A','chr1','115247623','C','115247618',],['G','chr1','115248027','T','115248024',],]],[1,6,17,3,[['G','chr15','31849109','-','31849099',],['A','chr15','31784365','G','31784356',],['C','chr15','31813946','G','31813946',],]],[1,6,20,4,[['C','chr10','96255604','T','96255604',],['C','chr10','96193071','G','96193066',],['G','chr10','96222596','T','96222590',],['T','chr10','96245374','C','96245369',],]],[1,6,22,4,[['A','chr13','27164713','-','27164711',],['T','chr13','27199154','-','27199149',],['-','chr13','27200441','A','27200438',],['T','chr13','27142707','C','27142697',],]],[1,8,9,1,[['A','chr6','44221477','C','44221471',],]],[1,8,17,1,[['T','chr15','31896120','A','31896118',],]],[1,9,22,1,[['G','chr13','27220832','T','27220832',],]],[2,1,15,1,[['A','chr2','178106425','T','178106419',],]],[2,4,1,1,[['A','chr15','45010313','-','45010306',],]],[2,4,8,2,[['-','chr10','8115640','A','8115635',],['G','chr10','8101243','-','8101233',],]],[2,4,11,1,[['C','chr15','90635191','A','90635183',],]],[2,4,15,1,[['-','chr2','178127035','C','178127026',],]],[2,4,16,1,[['C','chr1','115256410','T','115256405',],]],[2,4,19,1,[['A','chr10','89701981','C','89701978',],]],[2,6,0,1,[['A','chr3','38505663','T','38505661',],]],[2,6,5,1,[['T','chr2','25539245','-','25539241',],]],[2,6,6,1,[['A','chr4','153397915','T','153397912',],]],[2,6,8,3,[['T','chr10','8101399','G','8101399',],['G','chr10','8109783','T','8109781',],['A','chr10','8102405','G','8102397',],]],[2,6,10,1,[['G','chr2','209115799','C','209115796',],]],[2,6,11,2,[['T','chr15','90638261','-','90638256',],['C','chr15','90640754','-','90640749',],]],[2,6,13,1,[['C','chr6','131913052','-','131913047',],]],[2,6,16,3,[['A','chr1','115250052','T','115250043',],['G','chr1','115254652','T','115254645',],['-','chr1','115256419','T','115256411',],]],[2,7,0,1,[['T','chr3','38523568','-','38523567',],]],[2,8,5,1,[['C','chr2','25499265','G','25499257',],]],[2,9,14,1,[['T','chr9','20495358','A','20495358',],]],[2,9,19,1,[['A','chr10','89708818','C','89708816',],]],];
mut_data.mutations_sum = 76;

mut_data.Ids = ['SAMPLE00','SAMPLE01','SAMPLE02',];
mut_data.genes = ['ACVR2B','B2M','BRAF','CDH1','CNKSR1','DNMT3A','FBXW7','FLT3','GATA3','HSP90AB1','IDH1','IDH2','KRAS','MED23','MLL2','NFE2L2','NRAS','OTUD7A','PIK3CA','PTEN','TBC1D12','TRAF3','WASF3',];
mut_data.funcs = ['UTR3','UTR5','_blank_','downstream','exonic','intergenic','intronic','ncRNA_intronic','ncRNA_splicing','splicing',];
mut_data.func_colors_n = ['#F39600','#E60011','#9CAEB7','#E85299','#00A4DB','#009943','#D7C447','#6BBB5A','#00ADA6','#007AC2',];
mut_data.mutation_header = ['alt','chr','end','ref','start',];
mut_data.tooltip_format = {
checker_title:{format:[[{label:'ID:',type:'fix',keys:[],ext:''},{label:'{id}',type:'str',keys:['id',],ext:''},{label:', gene:',type:'fix',keys:[],ext:''},{label:'{gene}',type:'str',keys:['gene',],ext:''},{label:', ',type:'fix',keys:[],ext:''},{label:'{#sum_item_value}',type:'str',keys:['#sum_item_value',],ext:''},],], keys: '{#sum_item_value} {gene} {id} '},checker_partial:{format:[[{label:'type[',type:'fix',keys:[],ext:''},{label:'{group}',type:'str',keys:['group',],ext:''},{label:'], ',type:'fix',keys:[],ext:''},{label:'{chr}',type:'str',keys:['chr',],ext:''},{label:':',type:'fix',keys:[],ext:''},{label:'{start}',type:'str',keys:['start',],ext:''},{label:':',type:'fix',keys:[],ext:''},{label:'{end}',type:'str',keys:['end',],ext:''},{label:', [',type:'fix',keys:[],ext:''},{label:'{ref}',type:'str',keys:['ref',],ext:''},{label:' -----> ',type:'fix',keys:[],ext:''},{label:'{alt}',type:'str',keys:['alt',],ext:''},{label:']',type:'fix',keys:[],ext:''},],], keys: '{alt} {chr} {end} {group} {ref} {start} '},gene_title:{format:[[{label:'gene:',type:'fix',keys:[],ext:''},{label:'{gene}',type:'str',keys:['gene',],ext:''},{label:', ',type:'fix',keys:[],ext:''},{label:'{#sum_item_value}',type:'str',keys:['#sum_item_value',],ext:''},],], keys: '{#sum_item_value} {gene} '},gene_partial:{format:[[{label:'func:',type:'fix',keys:[],ext:''},{label:'{group}',type:'str',keys:['group',],ext:''},{label:', ',type:'fix',keys:[],ext:''},{label:'{#item_value}',type:'str',keys:['#item_value',],ext:''},],], keys: '{#item_value} {group} '},id_title:{format:[[{label:'ID:',type:'fix',keys:[],ext:''},{label:'{id}',type:'str',keys:['id',],ext:''},{label:', ',type:'fix',keys:[],ext:''},{label:'{#sum_item_value}',type:'str',keys:['#sum_item_value',],ext:''},],], keys: '{#sum_item_value} {id} '},id_partial:{format:[[{label:'func:',type:'fix',keys:[],ext:''},{label:'{group}',type:'str',keys:['group',],ext:''},{label:', ',type:'fix',keys:[],ext:''},{label:'{#item_value}',type:'str',keys:['#item_value',],ext:''},],], keys: '{#item_value} {group} '},
};
mut_data.subdata = [{name:"sub0",title:"Clinical Gender", type:"fix",item:['M','F',],label:['Male','Female',],colors_n:['#0000ff','#ff0000',],data:[[0,1],[1,1],[2,1],]},
{name:"sub1",title:"Clinical Age", type:"range",item:['20','40','60',],label:['0-19','20-39','40-59','60over',],colors_n:['#E51721','#0079BA','#019A68','#522886',],data:[[0,30],[1,62],[2,59],]},
{name:"sub2",title:"Clinical BMI", type:"gradient",item:['25.0','40.0',],label:['Min(15)','Max(40)',],colors_n:['#0000ff','#ff0000',],data:[[0,40],[1,25],[2,34],]},
];mut_data.Ids_keys = utils.create_key_list(mut_data.Ids);
mut_data.genes_keys = utils.create_key_list(mut_data.genes);

function calc_option(format, pos, sum, value) {
    
    var id = pos[0];
    var func = pos[1];
    var gene = pos[2];
    
    var obj = {id: mut_data.Ids[id], group: mut_data.funcs[func], gene: mut_data.genes[gene],
        '#number_gene': mut_data.genes.length, 
        '#number_id': mut_data.Ids.length, 
        '#number_mutaion_all': mut_data.mutations.length, 
        '#sum_mutaion_all': mut_data.mutations_sum,
        '#sum_item_value': sum,
        '#item_value': value,
    };

    return obj;
}
function tooltip_title(format, pos, sum) {
    
    var obj = calc_option(format, pos, sum, 0);
    
    var tooltip = [];
    for (var t in format.format) {
        tooltip.push(utils.text_format(format.format[t], obj));
    }
    return tooltip;
};

function tooltip_partial(format, pos, mutation, loop, value) {
    
    var obj = calc_option(format, pos, 0, value);
    
    var tooltip = [];
    for (var m in mutation) {
        for (var p = 0; p < mutation[m][4].length; p++) {
            for (var p2 = 0; p2 < mutation[m][4][p].length; p2++) {
                obj[mut_data.mutation_header[p2]] = mutation[m][4][p][p2];
            }
            for (var t in format.format) {
                var text = utils.text_format(format.format[t], obj);
                if (tooltip.indexOf(text) < 0){
                    tooltip.push(text);
                    if (loop == false) { break;}
                }
            }
            if (loop == false) { break;}
        }
        if (loop == false) { break;}
    }
    return tooltip;
};

mut_data.get_dataset_id = function () {
    
    var data = [];
    var keys = [];
    var tooltips = {};
    var sum_par_id = [];
    for (var i1=0; i1 < mut_data.Ids_keys.length; i1++) {
        tooltips[mut_data.Ids_keys[i1]] = [];
        sum_par_id[i1] = 0;
    }
    
    // par func
    for (var f=0; f < mut_data.funcs.length; f++) {

        data[f] = [];
        keys[f] = [];

        // par ID
        for (var i2=0; i2 < mut_data.Ids_keys.length; i2++) {
            
            var data_filt = mut_data.mutations.filter(function(item, index){
                if ((item[0] == i2) && (item[1] == f)) return true;
            });
            
            var sum = 0;
            for (var d in data_filt) sum += data_filt[d][3];
            if (sum > 0) {
                data[f].push(sum);
                keys[f].push(mut_data.Ids_keys[i2]);
                tooltips[mut_data.Ids_keys[i2]].push(tooltip_partial(mut_data.tooltip_format.id_partial, [i2, f, null], data_filt, false, sum));
                sum_par_id[i2] += sum;
            }
        }
    }
    for (var i3=0; i3 < mut_data.Ids_keys.length; i3++) {
        var title = tooltip_title(mut_data.tooltip_format.id_title, [i3, null, null], sum_par_id[i3]);
        for (var t = 0; t < title.length; t++) {
            tooltips[mut_data.Ids_keys[i3]].splice(t, 0, title[t]);
        }
    }
    
    return {data: data, keys: keys, tooltips: tooltips};
};

mut_data.get_dataset_checker = function (func_flgs, use_genes) {
    
    // tooltips
    var tooltips_matrix = [];
    {
        for (var i in mut_data.Ids_keys) {
            tooltips_matrix[i] = {};
        }
        
        for (var d1 in mut_data.mutations) {
            var data_tmp = mut_data.mutations[d1];
            if (func_flgs[mut_data.funcs[data_tmp[1]]] == false) continue;
            if (use_genes.indexOf(mut_data.genes_keys[data_tmp[2]]) < 0) continue;
            
            if (tooltips_matrix[data_tmp[0]][mut_data.genes_keys[data_tmp[2]]] == null) {
                var data_filt = mut_data.mutations.filter(function(item, index){
                    if ((item[0] == data_tmp[0]) && (item[2] == data_tmp[2])) return true;
                });
                
                var sum = 0;
                for (var d2 in data_filt) sum += data_filt[d2][3];
                tooltips_matrix[data_tmp[0]][mut_data.genes_keys[data_tmp[2]]] = tooltip_title(mut_data.tooltip_format.checker_title, [data_tmp[0], null, data_tmp[2]], sum);
            }
            var texts = tooltip_partial(mut_data.tooltip_format.checker_partial, [data_tmp[0],data_tmp[1],data_tmp[2]], [data_tmp], true, 1);
            for (var t in texts) {
                tooltips_matrix[data_tmp[0]][mut_data.genes_keys[data_tmp[2]]].push(texts[t]);
            }
        }
    }
    
    var data = [];
    var keys = [];
    var keys2 = [];
    for (var f=0; f < mut_data.funcs.length; f++) {
        
        data[f] = [];
        keys[f] = [];
        keys2[f] = [];
        
        if (func_flgs[mut_data.funcs[f]] == false) continue;
        
        var data_filt2 = mut_data.mutations.filter(function(item, index){
            if (item[1] == f) return true;
        });
        
        // par data
        for (var d3 in data_filt2) {
            if (use_genes.indexOf(mut_data.genes_keys[data_filt2[d3][2]]) < 0) continue;
            data[f].push(1);
            keys[f].push(mut_data.Ids_keys[data_filt2[d3][0]]);
            keys2[f].push(mut_data.genes_keys[data_filt2[d3][2]]);
        }
    }
    
    return {data: data, keys: keys, keys2: keys2, tooltips: tooltips_matrix};
};

function extract_gene(func_flgs, gene_th, gene_max, sort_name_y, sort_asc_y) {

    var g = 0
    var gene_nums = [];
    {
        for (g = 0; g < mut_data.genes_keys.length; g++) {
            gene_nums[g] = 0;
        }
        var gene_Ids = [];
        for (var i in mut_data.Ids_keys) {
            gene_Ids[i] = [];
        }
        for (var d in mut_data.mutations) {
            var data = mut_data.mutations[d];
            if (func_flgs[mut_data.funcs[data[1]]] == false) continue;
            if (gene_Ids[data[0]].indexOf(data[2]) >= 0) continue;
            
            gene_Ids[data[0]].push(data[2]);
            gene_nums[data[2]] += 1;
        }
    }

    // sort
    var gene_obj = [];
    {
        for (g in mut_data.genes_keys) {
            if (gene_nums[g] * 100.0 / mut_data.Ids_keys.length < gene_th) continue;
            if (gene_nums[g] == 0) continue;

            gene_obj.push({name: mut_data.genes[g], num: gene_nums[g]});
        }
        
        var ret = 1;
        if (sort_asc_y[0] == false) ret = -1;
        
        gene_obj.sort(function (a, b) {
            
            if (sort_name_y[0] == "number_of_mutations") {

                if( a.num < b.num ) return -ret;
                if( a.num > b.num ) return ret;
                if( a.name < b.name ) return -ret;
                if( a.name > b.name ) return ret;
                return 0;
            }
            if (sort_name_y[0] == "name") {

                if( a.name < b.name ) return -ret;
                if( a.name > b.name ) return ret;
                return 0;
            }
        });
    }

    var gene_nums_ex = [];
    var gene_keys = [];
    var gene_names = [];
    for (g in gene_obj) {
        if (g >= gene_max) break;
        gene_nums_ex.push(gene_obj[g].num);
        gene_keys.push(mut_data.genes_keys[mut_data.genes.indexOf(gene_obj[g].name)]);
        gene_names.push(gene_obj[g].name);
    }
    
    return {keys: gene_keys, names: gene_names, values: gene_nums_ex, uncut_length: gene_obj.length};
};

mut_data.get_dataset_gene = function (func_flgs, gene_th, gene_max, sort_name_y, sort_asc_y) {
    
    var gene_nums = [];
    var genes = [];
    var g = 0, ex_g = 0, f = 0;
    
    for (f=0; f < mut_data.funcs.length; f++) {
        gene_nums[f] = [];
        genes[f] = [];
    }
    var ex_genes = extract_gene(func_flgs, gene_th, gene_max, sort_name_y, sort_asc_y);

    var gene_ids = [];
    var tooltips = {};
    for (ex_g=0; ex_g < ex_genes.keys.length; ex_g++) {
        g = mut_data.genes_keys.indexOf(ex_genes.keys[ex_g]);
        gene_ids[ex_g] = [];
        tooltips[ex_genes.keys[ex_g]] = tooltip_title(mut_data.tooltip_format.gene_title, [null, null, g], ex_genes.values[ex_g]);
    }
    
    // par func
    for (f=0; f < mut_data.funcs.length; f++) {
        if (func_flgs[mut_data.funcs[f]] == false) continue;
        // par gene
        for (ex_g=0; ex_g < ex_genes.keys.length; ex_g++) {
            g = mut_data.genes_keys.indexOf(ex_genes.keys[ex_g]);
            var data_filt = mut_data.mutations.filter(function(item, index){
                if ((item[2] == g) && (item[1] == f)) return true;
            });
            var sum = 0;
            // par data
            for (var d=0; d < data_filt.length;d++) {
                if (gene_ids[ex_g].indexOf(data_filt[d][0]) >= 0) continue;
                gene_ids[ex_g].push(data_filt[d][0]);
                sum = sum + 1;
            }
            if (sum > 0) {
                var value = sum * 100.0 / mut_data.Ids_keys.length;
                
                gene_nums[f].push(value);
                genes[f].push(ex_genes.keys[ex_g]);
                
                var texts = tooltip_partial(mut_data.tooltip_format.gene_partial, [null, f, g], data_filt, false, sum);
                for (var t in texts) {
                    tooltips[ex_genes.keys[ex_g]].push(texts[t]);
                }
            }
        }
    }

    return {data: gene_nums, keys: genes, tooltips: tooltips, total_keys: ex_genes.keys, total_names: ex_genes.names, total_nums: ex_genes.values, uncut_length: ex_genes.uncut_length};
};
    
mut_data.get_id_nums = function (func_flgs, data, keys) {

    var id_nums = [];
    for (var i in mut_data.Ids_keys) {
        id_nums[i] = 0;
    }
    
    for (var f=0; f < data.length; f++) {
        if (func_flgs[mut_data.funcs[f]] == false) continue;
        
        for (var d=0; d < data[f].length; d++) {
            id_nums[mut_data.Ids_keys.indexOf(keys[f][d])] += data[f][d];
        }
    }
    
    return id_nums;
};

// for water-fall
mut_data.get_id_flg_par_gene = function (name, func_flgs) {
    
    var id_nums = [];
    
    // par ID
    var idx_g = 0;
    
    for (var g = 0; g < mut_data.genes_keys.length; g++) {
        if (mut_data.genes_keys[g] == name) {
            idx_g = g;
            break;
        }
    }
    
    for (var i in mut_data.Ids_keys) {
        
        var data_filt = mut_data.mutations.filter(function(item, index){
            if ((item[2] == idx_g) && (item[0] == i)) return true;
        });
        
        var sum = 0;
        // par data
        for (var d=0; d < data_filt.length;d++) {
            // count only visible funcs
            if (func_flgs[mut_data.funcs[data_filt[d][1]]] == false) continue;
            sum = 1;
            break;
        }
        
        id_nums.push(sum);
    }
    
    return id_nums;
};

mut_data.get_sub_data = function (name) {
    var i = 0;
    var sub = {}
    // par sub
    for (i = 0; i < mut_data.subdata.length; i++) {
        if (mut_data.subdata[i].name == name) {
            sub = mut_data.subdata[i];
            break;
        }
    }
    if (sub.length == 0) return {};

    // par item
    var stack_length = sub.item.length;
    if (sub.type == "range") stack_length = stack_length + 1;
    
    var gradient_stack_d = [];
    if (sub.type == "gradient") {
        
        var gradient_stack = [];
        for (i = 0; i < sub.data.length; i++) {
            gradient_stack.push(sub.data[i][1]);
        }
        gradient_stack.sort(function(a,b){
            if( a < b ) return -1;
            if( a > b ) return 1;
            return 0;
        });
        gradient_stack_d = gradient_stack.filter(function (x, i, self) {
            return self.indexOf(x) === i;
        });
        stack_length = gradient_stack_d.length;
    }
    
    var stack = [];
    var tooltips = {};
    
    for (i = 0; i < stack_length; i++) {
        stack[i] = {};
        stack[i].data = [];
        stack[i].keys = [];
        
        if (sub.type == "gradient") {
            stack[i].color_n = "";
        }
        else {
            stack[i].color_n = sub.colors_n[i];
        }
    }
    
    // par data
    for (i = 0; i < sub.data.length; i++) {
        
        var id = mut_data.Ids_keys[sub.data[i][0]];
        var s = -1, l = 0;
        var val = "";
        
        if (sub.type == "range") {
            val = sub.data[i][1];
            for (l = 0; l < sub.item.length; l++) {
                if (val < sub.item[l]) {
                    s = l;
                    break;
                }
            }
            if (s == -1) {
                s = sub.item.length;
            }
        }
        else if (sub.type == "gradient") {
            val = sub.data[i][1];
            for (l = 0; l < gradient_stack_d.length; l++) {
                if (val == gradient_stack_d[l]) {
                    s = l;
                    break;
                }
            }
            if (stack[s].color_n == "") {
                stack[s].color_n = utils.color_gradient(val, sub.item, sub.colors_n);
            }
        }
        else { // "fix"
            s = sub.data[i][1];
            if (s >= sub.item.length) {
                console.log(name + ": not contain:" + s);
                continue;
            }
            val = sub.item[s];
        }
        
        var p = stack[s].data.length;
        stack[s].data[p] = 1;
        stack[s].keys[p] = id;
        tooltips[id] = [id + ", " + val];
    }
    
    return {stack: stack, tooltips: tooltips, label: {type: sub.type, text: sub.label, color: sub.colors_n}};
};
mut_data.get_sub_values = function (name) {
    var values = [];
    
    for (var f = 0; f < mut_data.subdata.length; f++) {
        if (mut_data.subdata[f].name != name) continue;
        
        // par ID
        for (var i in mut_data.Ids_keys) {
            
            var data_filt = mut_data.subdata[f].data.filter(function(item, index){
                if (item[0] == i) return true;
            });
            
            values.push(data_filt[0][1]);
        }
        break;
    }
    return values;
};

})();
Object.freeze(mut_data);
